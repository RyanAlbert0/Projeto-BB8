<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../imagens/icon-bb8.png">
    <title>Montar Saída - BB8 Archaeologist</title>
</head>
<body>

    <div id="header">
        <button onclick="window.location.href = '../interface/interface.html'" id="home"><img src="../imagens/casa.png" width="50" height="50"></button>
        <h1>Montar Saída - BB8: Archaeologist</h1>
        <img src="../imagens/Logo SESI 2.png" id="logoSESI">
    </div>

    <div id="content">
        <div id="img">
        <canvas id="mesa" width="1280" height="720" style="border: 1px solid black;"></canvas>
        <img src="../imagens/table.jpg" id="mesaIMG" style="display: none;">
        </div>
    </div>
    <div id="userInputs">
        <input id="nomeSaidaInput" type="text" placeholder="Defina o nome da saída">
        <input id="corSaidaInput" type="color">
        <button id="enviarSaidaBTN" onclick="enviar()" type="button">Enviar Saídas</button>
        <div id="informacoesUsuario">
            <label id="pontosSelecionadosTexto">Nenhum ponto selecionado</label>
            <p id="pontosSelecionadosOutput"></p>
            <label>Bases:</label>
            <p id="basesDefinidas">Bases não selecionadas</p>
        </div>
        <button id="removerPontosBTN" type="button" onclick="removerPontos()">Apagar pontos</button>
        

    </div>
</body>

<script>
    // Declara o array de botões
    let botoes = []

    // Declara o array com a entrada e a saída
    let InOutPos = []

    // Declara o array com a entrada e a saída definida pelo usuário
    let InOut = []

    // Array da saida
    let saida = []

    // Array dos pontos
    let pontos = []

    // Array de pontos para texto
    let pontosTexto = []

    // Variável com a confirmação do usuário
    let resp = false

    // Declara o event listener como false
    let eventListenerAtivado = false
    
    // Declara o label e o texto que irá exibir as informações
    const outputLabel = document.getElementById('pontosSelecionadosTexto')
    const outputTexto = document.getElementById('pontosSelecionadosOutput') 

    // Ativa as funções do Canvas e do Clique
    canvas()
    clique()
    
    // Função para realizar todas as operações de renderização do Canvas
    function canvas() 
    {
        // Identifica o Canvas
        const c = document.getElementById('mesa')

        // Declara o canvas como um objeto 2D
        const ctx = c.getContext('2d')


        // Tabela de coordenadas
        let coordenadas = JSON.parse(sessionStorage.getItem('coordenadas'))

        // Pontos base
        const pontosBase = JSON.parse(sessionStorage.getItem('pontosBase'))

        // Carrega a imagem no Canvas
        const img = document.getElementById('mesaIMG')

        // Se a imagem estiver carregada, aplique ao Canvas
        img.onload = function()
        {
            ctx.drawImage(img, 0, 0, 1280, 720)

            // Cria os pontos com base na tabela de coordenadas
            for (i = 0; i < coordenadas.length; i++)
            {
    
                // Pega as coordenadas com base na contagem 'i'
                let x = coordenadas[i][0]
                let y = coordenadas[i][1]
    
                // Desenha o círculo na coordenada atual
                ctx.beginPath()
                ctx.arc(x, y, 15, 0, 2 * Math.PI)
                ctx.fillStyle = 'orange'
                ctx.strokeStyle = 'orange'
                ctx.fill()
                ctx.stroke()
                ctx.save()
    
                // Desenha o texto para a coordenada atual acima do círculo
                ctx.font = '20px Arial'
                ctx.textAlign = 'center'
                ctx.fillStyle = 'black'
                ctx.fillText(i + 1, x, y + 8)
                ctx.restore()
    
                // Salva as informações de coordenada, diâmetro e nome do botão
                let botao = {'x': x, 'y': y, 'size': 15, 'nome': i}
    
                // Envia para o Array Botões
                botoes.push(botao)
            }

            // Desenha as bases
            for(i = 0; i < pontosBase.length; i++)
            {
                // Declara os dados necessários
                const nome = pontosBase[i][0]
                const cor = pontosBase[i][1]
                const x = pontosBase[i][2]
                const y = pontosBase[i][3]

                // Faz o traço do círculo
                ctx.beginPath()
                ctx.arc(x, y, 30, 0, 2 * Math.PI)
                ctx.fillStyle = cor
                ctx.strokeStyle = cor
                ctx.fill()
                ctx.stroke()
                ctx.save()

                // Desenha o texto
                ctx.font = '20px Arial'
                ctx.textAlign = 'center'
                ctx.fillStyle = 'black'
                ctx.fillText(nome, x, y + 8)
                ctx.restore()

                // Salva os dados da base
                let pos = {'x': x, 'y': y, 'size': 30, 'nome': nome}

                // Envia a base para InOut
                InOutPos.push(pos)
            }
        }




    }

    // Função para realizar todas as operações de detecção de clique do Canvas
    function clique()
    {

        // Declarar o Canvas
        const canvas = document.getElementById('mesa')

        // Checa se o Canvas já tem o Event Listener
        if (eventListenerAtivado == false)
        {
            // Adiciona o Event Listener de tipo Clique
            canvas.addEventListener('click', function(event)
            {
                // Define o tamanho do Canvas e a posição
                const rect = canvas.getBoundingClientRect()
    
                // Define a posição X e Y do mouse
                const mouseX = event.clientX - rect.left
                const mouseY = event.clientY - rect.top

                // Loop para detectar se algum botão de coordenada foi clicado
                botoes.forEach(botao => {

                    // Lógica para detectar se o mouse está dentro das extremidades do botão
                    if (mouseX > botao.x - 10 && mouseX < botao.x + 10 && mouseY > botao.y - 10 && mouseY < botao.y + 10)
                    {

                        // Envia o botão selecionado para um array da saída
                        pontos.push(botao.nome)

                        // Adapta o nome dos botões para visualização
                        pontosTexto.push(botao.nome + 1)

                        // Checa se tem um ou mais pontos em pontos
                        if(pontos.length == 1)
                        {
                            // Adapta o outputTexto para o singular
                            outputLabel.innerText = 'O ponto selecionado foi: '
                        }
                        else if (pontos.length > 1)
                        {
                            // Emite o output para o usuário
                            outputLabel.innerText = 'Os pontos selecionados foram: ' 
                        }
                        else
                        {
                            // Emite o output para o usuário
                            outputLabel.innerText = 'Sem pontos selecionados' 
                        }

                        // Ajusta o output
                        outputTexto.innerText = pontosTexto
                    }
                })

                // Loop para detectar se algum botão de base foi clicado
                InOutPos.forEach(botao => {
                    if (mouseX > botao.x - 30 && mouseX < botao.x + 30 && mouseY > botao.y - 30 && mouseY < botao.y + 30)
                    {

                        const p = document.getElementById('basesDefinidas')

                        if(InOut.length < 2)
                        {
                            InOut.push(botao.nome)
                            p.innerText = InOut

                        }
                        else
                        {
                            let resp = confirm(`O limite de pontos de base é 2!\nDeseja remover os pontos atuais?`)
                            if(resp)
                            {
                                InOut = []
                                window.alert('Pontos base removidos com sucesso')
                                p.innerText = 'Bases não selecionadas'
                            }
                            else
                            {

                            }
                        }
                    }
                })

            })
            
            // Define o Event Listener como ativado
            eventListenerAtivado = true
        }
        
    }

    function enviar()
    {

        // Define o validador de saída
        let saidaIsTrue = false

        // Define o validador de pontos
        let pontosIsTrue = false

        // Define o validador de bases
        let basesIsTrue = false

        // Identifica o input responsável pelo nome da saída
        let nomeSaida = document.getElementById('nomeSaidaInput').value

        // Verifica se não há uma saída com esse mesmo nome
        const saidaExistente = JSON.parse(localStorage.getItem(nomeSaida))

        // Identifica o input responsável pela cor da saída
        let corSaida = document.getElementById('corSaidaInput').value

        // Verifica se a saída é válida
        if(nomeSaida == '')
        {   
            // Se não for, exibe o alerta e define o validador de saída como false
            saidaIsTrue = false
            window.alert('Você não definiu o nome da saída!')
        }
        else
        {
            // Caso contrário, define o validador como true
            saidaIsTrue = true
        }

        // Verifica se a seleção de pontos é válida
        if(pontos.length == 0)
        {
            // Se não for, exibe o alerta e define o validador de pontos como false
            pontosIsTrue = false
            window.alert('Você não definiu pontos!')
        }
        else
        {
            // Caso contrário, define o validador como true
            pontosIsTrue = true
        }

        // Verifica se as bases são válidas
        if(InOut.length != 2)
        {
            // Se não for, exibe o alerta e define o validador de base como false
            basesIsTrue = false
            window.alert(`Você não definiu as duas bases!`)
        }
        else
        {
            // Caso contrário, define o validador como true
            basesIsTrue = true
        }

        // Cria as mensagens

        msgDup = `
        
            A saída com nome ${nomeSaida} já existe!
            Os pontos selecionados são ${pontosTexto}.
            
            Deseja prosseguir com a substituição?
            `

        // Envia a missão selecionada para o LocalStorage
        msg = `

            Você está prestes a definir a missão ${nomeSaida}
            com os pontos ${pontosTexto}.
            
            Deseja prosseguir?
        
        `
        // Verifica se todos os validadores são true
        if(pontosIsTrue && saidaIsTrue && basesIsTrue)
        {
            // Verifica se já existe uma saída no localStorage
            if(saidaExistente != null)
            {
                // Se houver, pergunte se quer substituir
                resp = confirm(msgDup)
            }
            else
            {
                // Se não, pede confirmação do usuário
                resp = confirm(msg)
            }

            // Se a resposta do usuário for verdadeira (seja para substituir, seja para salvar)
            if(resp)
            {

            // Salva todos os dados no Array de saída
            saida.push(corSaida, pontos, InOut)
            
            // Executa a função
            localStorage.setItem(nomeSaida, JSON.stringify(saida))
            
            // Recarrega a página
            window.location.reload()
            }
        }

        
        
    }
    


    // Função para excluir pontos específicos
    function removerPontos()
    {
        // Define as mensagens dinâmicas
        multiponto = `Você está prestes a apagar os pontos. Tem certeza?
        Os pontos a serem excluídos são: ${pontosTexto}`

        uniponto = `Você está prestes a apagar apenas um ponto. Tem certeza?
        Você ira apagar o ponto ${pontosTexto}`

        // Ajusta dinamicamente
        if(pontos.length == 1 && confirm(uniponto))
        {
            // Avisa e realiza a limpeza
            window.alert(`Você apagou o ponto ${pontosTexto}`)
            pontos = []

            // Emite o output para o usuário
            outputLabel.innerText = 'Sem pontos selecionados' 
            outputTexto.innerText = pontosTexto
        }

        else if (pontos.length > 1 && confirm(multiponto))
        {
            // Avisa e realiza a limpeza
            window.alert(`Você apagou os pontos ${pontosTexto}`)
            pontos = []
            pontosTexto = []

            // Emite o output para o usuário
            outputLabel.innerText = 'Sem pontos selecionados' 
            outputTexto.innerText = pontosTexto
        }

        else
        {
            // Retorna a mensagem
            window.alert(`Operação cancelada! O usuário negou a operação ou não há botões a serem apagados`)
        }
    }
    
</script>

</html>